{% extends "base.html" %}

{% block title %}Cancelaciones - Vitatec{% endblock %}

{% block content %}
<h2>Cancelaciones registradas</h2>
<div class="card-body">
  <p><strong>üìã Total de cancelaciones:</strong> {{ total_cancelaciones }}</p>
  <p><strong>üö® Pacientes con 3 o m√°s cancelaciones:</strong> {{ pacientes_mas_de_3 }}</p>
  <p><strong>üîÅ Porcentaje que pidi√≥ reagendar:</strong> {{ porcentaje_reagendar }}%</p>
</div>
<input type="text" id="buscarDNI" placeholder="Buscar por DNI o N¬∫ Cliente..." style="margin-top: 20px; width: 100%; padding: 10px; font-size: 1em; border-radius: 8px; border: 1px solid #ccc;">
<p>Total de cancelaciones: {{ cancelaciones|length }}</p>

<table class="tabla">
  <thead>
    <tr>
      <th>DNI</th>
      <th>Motivo</th>
      <th>Comentario</th>
      <th>Mejora</th>
      <th>Reagendar</th>
      <th>Timestamp</th>
      <th>Cancelaciones</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for c in cancelaciones %}
    <tr {% if c.cancelaciones|int >= 3 %}style="background-color: #f8d7da;"{% endif %}>
      <td>{{ c.DNI or c.dni }}</td>
      <td>{{ c.motivo }}</td>
      <td>{{ c.comentario }}</td>
      <td>{{ c.mejora }}</td>
      <td>{{ c['Ayuda reagendar'] }}</td>
      <td>{{ c.timestamp }}</td>
      <td>{{ c.cancelaciones }}</td>
      <td>
        <button class="btn-eliminar" onclick="eliminarCancelacion('{{ c.dni }}', '{{ c.timestamp }}')">Eliminar</button> </td>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  function eliminarCancelacion(dni, timestamp) {
    if (!confirm("¬øEst√°s seguro de eliminar esta cancelaci√≥n?")) return;

    fetch("/webhook/eliminar-cancelacion", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": "{{ API_KEY }}"
      },
      body: JSON.stringify({ dni, timestamp })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        location.reload();
      } else {
        alert("‚ùå Error al eliminar: " + data.message);
      }
    })
    .catch(err => {
      console.error(err);
      alert("‚ùå Error de red al eliminar.");
    });
  }
</script>
<script>
  document.getElementById("buscarDNI").addEventListener("input", function () {
    const filtro = this.value.toLowerCase();
    const filas = document.querySelectorAll("tbody tr");

    filas.forEach(fila => {
      const dni = fila.querySelector("td").textContent.toLowerCase();
      if (dni.includes(filtro)) {
        fila.style.display = "";
      } else {
        fila.style.display = "none";
      }
    });
  });
</script>

{% endblock %}
